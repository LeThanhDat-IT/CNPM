<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tìm kiếm phòng khách sạn</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(120deg, #f0f2f5 60%, #e9eafc 100%);
      min-height: 100vh;
    }
    header {
      background: linear-gradient(90deg, #1a2d6c 60%, #d10000 100%);
      color: white;
      padding: 18px 38px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 18px rgba(34,59,121,0.10);
    }
    header h1 {
      margin: 0;
      font-size: 2em;
      letter-spacing: 2px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header img {
      height: 48px;
      cursor: pointer;
      border-radius: 8px;
      margin-right: 18px;
      box-shadow: 0 2px 8px rgba(34,59,121,0.10);
      transition: transform 0.15s;
    }
    header img:hover { transform: scale(1.07); }
    header button {
      background: #fff;
      color: #1a2d6c;
      font-weight: bold;
      padding: 10px 22px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 1.08em;
      transition: background 0.2s, color 0.2s;
      box-shadow: 0 2px 8px rgba(34,59,121,0.08);
      margin-left: 18px;
    }
    header button:hover {
      background: #d10000;
      color: #fff;
    }
    .container {
      display: flex;
      max-width: 1350px;
      margin: 38px auto 0 auto;
      padding: 0 18px;
      gap: 28px;
      align-items: flex-start;
    }
    .filter {
      width: 320px;
      background: #fff;
      padding: 28px 22px 22px 22px;
      border-radius: 16px;
      box-shadow: 0 4px 18px rgba(34,59,121,0.09);
      position: sticky;
      top: 32px;
      z-index: 2;
      min-width: 260px;
    }
    .filter h3 {
      margin-bottom: 16px;
      font-size: 1.18em;
      color: #223B79;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .filter label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
      color: #223B79;
      font-size: 1.04em;
    }
    .filter input, .filter select {
      width: 100%;
      padding: 9px 10px;
      border: 1.5px solid #cfd8e3;
      border-radius: 7px;
      font-size: 1em;
      background: #f8fafc;
      transition: border 0.2s;
    }
    .filter input:focus, .filter select:focus {
      border-color: #1a2d6c;
      outline: none;
    }
    .filter input[type="radio"] {
      width: auto;
      margin-right: 7px;
      accent-color: #d10000;
    }
    .filter button {
      margin-top: 22px;
      width: 100%;
      padding: 12px 0;
      background: linear-gradient(90deg, #1a2d6c 60%, #d10000 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1.08em;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px rgba(34,59,121,0.08);
    }
    .filter button:hover {
      background: linear-gradient(90deg, #d10000 60%, #1a2d6c 100%);
      transform: translateY(-2px) scale(1.03);
    }
    .results {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .room-card {
      display: flex;
      background: #fff;
      padding: 18px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(34,59,121,0.08);
      transition: 0.3s;
      cursor: pointer;
      position: relative;
      align-items: flex-start;
      gap: 22px;
    }
    .room-card:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 8px 24px rgba(34,59,121,0.13);
      background: #f6f8fc;
    }
    .room-card img {
      width: 200px;
      height: 130px;
      border-radius: 10px;
      object-fit: cover;
      margin-right: 0;
      box-shadow: 0 2px 8px rgba(34,59,121,0.10);
      background: #f0f2f5;
    }
    .room-info { flex: 1; }
    .room-info h4 {
      margin: 0 0 8px;
      font-size: 1.25em;
      color: #223B79;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .room-info .details {
      color: #555;
      margin-bottom: 10px;
      font-size: 1.04em;
      font-weight: 500;
    }
    .room-info .price {
      font-size: 1.18em;
      font-weight: bold;
      color: #d10000;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
    }
    .room-info button {
      background: linear-gradient(90deg, #1a2d6c 60%, #d10000 100%);
      color: white;
      padding: 9px 22px;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.04em;
      transition: background 0.2s, transform 0.1s;
      box-shadow: 0 2px 8px rgba(34,59,121,0.08);
      margin-top: 8px;
    }
    .room-info button:hover {
      background: linear-gradient(90deg, #d10000 60%, #1a2d6c 100%);
      transform: scale(1.04);
    }
    .history-section {
      max-width: 1350px;
      margin: 38px auto 0 auto;
      padding: 0 18px 18px 18px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(34,59,121,0.08);
      position: relative;
      z-index: 1;
    }
    .history-section h3 {
      margin: 0 0 18px 0;
      color: #223B79;
      font-size: 1.18em;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .history-list {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
    }
    .history-item {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 16px 20px;
      min-width: 240px;
      box-shadow: 0 1px 4px rgba(34,59,121,0.06);
      margin-bottom: 10px;
      font-size: 1.02em;
      font-weight: 500;
      color: #223B79;
      transition: box-shadow 0.2s;
    }
    .history-item strong { color: #d10000; font-size: 1.08em; }
    .history-item span {
      display: block;
      color: #444;
      margin-top: 4px;
      font-size: 0.98em;
      font-weight: 400;
    }
    /* Popup chi tiết phòng */
    .room-detail-popup {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.35);
      align-items: center;
      justify-content: center;
    }
    .room-detail-popup.active {
      display: flex;
    }
    .room-detail-content {
      background: #fff;
      border-radius: 18px;
      max-width: 420px;
      width: 95vw;
      padding: 28px 18px 18px 18px;
      box-shadow: 0 8px 32px rgba(34,59,121,0.18);
      position: relative;
      animation: popupShow 0.2s;
    }
    @keyframes popupShow {
      from { transform: translateY(40px) scale(0.98); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    .room-detail-content h2 {
      margin-top: 0;
      color: #223B79;
      font-size: 1.35em;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .room-detail-content ul { padding-left: 18px; }
    .room-detail-content .close-btn {
      position: absolute;
      top: 12px; right: 18px;
      background: none;
      border: none;
      font-size: 22px;
      color: #223B79;
      cursor: pointer;
    }
    .room-detail-content img {
      width: 100%;
      max-height: 180px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 14px;
      box-shadow: 0 2px 8px rgba(34,59,121,0.10);
      background: #f0f2f5;
    }
    .room-detail-content .price {
      color: #d10000;
      font-size: 1.18em;
      font-weight: bold;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
    }
    .room-detail-content .section-title {
      font-weight: bold;
      margin-top: 12px;
      margin-bottom: 4px;
      color: #223B79;
      font-size: 1.04em;
    }
    .room-detail-content .book-btn {
      display: block;
      width: 92%;
      margin: 18px auto 0 auto;
      padding: 12px 0;
      background: linear-gradient(90deg, #1a2d6c 60%, #d10000 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.08em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      text-align: center;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px rgba(34,59,121,0.08);
    }
    .room-detail-content .book-btn:hover {
      background: linear-gradient(90deg, #d10000 60%, #1a2d6c 100%);
      color: #fff;
    }
    @media (max-width: 1100px) {
      .container { flex-direction: column; }
      .filter { width: 100%; max-width: 500px; margin: 0 auto 18px auto; }
      .results { width: 100%; }
    }
    @media (max-width: 700px) {
      .container, .history-section { padding: 0 2px; }
      .room-card { flex-direction: column; align-items: stretch; }
      .room-card img { width: 100%; height: 160px; margin-bottom: 10px; }
      .filter { padding: 16px 6px; }
      .room-detail-content { padding: 12px 4px; }
    }
  </style>
</head>
<body>

  <header>
    <img src="images/a3.jpg" alt="Logo" onclick="window.location.href='HomePage.html'">
    <h1><i class="fa-solid fa-hotel"></i> THE COW</h1>
    <button onclick="window.location.href='LichSuDatPhong.html'"><i class="fa-solid fa-clock-rotate-left"></i> Lịch Sử Đặt Phòng</button>
  </header>

  <div class="container">
    <div class="filter">
      <h3><i class="fa-solid fa-filter"></i> Tìm kiếm phòng</h3>
      <label for="searchName">Tên phòng</label>
      <input type="text" id="searchName" placeholder="Nhập tên phòng...">

      <label for="guests">Số người</label>
      <select id="guests">
        <option value="">Tất cả</option>
        <option value="1">1 người</option>
        <option value="2">2 người</option>
        <option value="3">3 người</option>
        <option value="4">4 người</option>
      </select>

      <h3 style="margin-top: 20px;"><i class="fa-solid fa-sort-amount-down"></i> Sắp xếp kết quả</h3>
      <label><input type="radio" name="sort" value="desc" checked> Giá cao nhất</label>
      <label><input type="radio" name="sort" value="asc"> Giá thấp nhất</label>
      <label><input type="radio" name="sort" value="popular"> Thuê nhiều nhất</label>

      <h3 style="margin-top: 20px;"><i class="fa-solid fa-money-bill-wave"></i> Lọc theo giá</h3>
      <label for="minPrice">Tối thiểu</label>
      <input type="number" id="minPrice" value="0">

      <label for="maxPrice">Tối đa</label>
      <input type="number" id="maxPrice" value="100000000">

      <button onclick="applyFilter()"><i class="fa-solid fa-magnifying-glass"></i> Áp dụng</button>
    </div>

    <div class="results" id="room-list">
      <!-- Danh sách phòng -->
    </div>
  </div>

  <!-- Lịch sử thuê phòng -->
  <div class="history-section">
    <h3><i class="fa-solid fa-clock-rotate-left"></i> Lịch sử thuê phòng</h3>
    <div class="history-list" id="history-list">
      <!-- Lịch sử sẽ được render ở đây -->
    </div>
  </div>

  <!-- Popup chi tiết phòng -->
  <div class="room-detail-popup" id="roomDetailPopup" onclick="closeRoomDetail()">
    <div class="room-detail-content" id="roomDetailContent" onclick="event.stopPropagation()">
      <!-- Nội dung chi tiết phòng sẽ được render ở đây -->
    </div>
  </div>

<script>
  let rooms = [];

  async function fetchRooms() {
    try {
      const res = await fetch('PHP/get_phong.php');
      const data = await res.json();
      rooms = data.map(room => ({
        code: room.maPhong,
        name: room.tenPhong,
        price: Number(room.giaPhong),
        guests: room.kieuPhong == 1 ? 1 : (room.kieuPhong == 2 ? 2 : 4),
        img: room.hinhAnh && room.hinhAnh.trim() !== '' ? room.hinhAnh : 'images/default-room.jpg',
        popularity: 0,
        bedType: room.loaiGiuong || 'Chưa cập nhật',
        amenities: room.tienNghi ? room.tienNghi.split(',').map(s => s.trim()) : [],
        services: [],
        area: room.dienTich || 'Chưa cập nhật'
      }));
      renderRooms(rooms);
    } catch (e) {
      document.getElementById('room-list').innerHTML = '<p style="color:#d10000;">Không thể tải danh sách phòng!</p>';
    }
  }

  function renderRooms(list) {
    const container = document.getElementById('room-list');
    container.innerHTML = '';
    if (list.length === 0) {
      container.innerHTML = '<p style="color: #d10000;">Không tìm thấy phòng phù hợp.</p>';
      return;
    }
    list.forEach((room, idx) => {
      const card = document.createElement('div');
      card.className = 'room-card';
      card.onclick = (e) => {
        if (e.target.tagName === 'BUTTON') return;
        showRoomDetail(room);
      };
      card.innerHTML = `
        <img src="${room.img}" alt="${room.name}">
        <div class="room-info">
          <h4>${room.name}</h4>
          <div class="details"><i class="fa-solid fa-user-group"></i> ${room.guests} người &nbsp; | &nbsp; <i class="fa-solid fa-bed"></i> ${room.bedType} &nbsp; | &nbsp; <i class="fa-solid fa-maximize"></i> ${room.area}</div>
          <div class="price"><i class="fa-solid fa-money-bill-wave"></i> ${room.price.toLocaleString()} đ</div>
          <button onclick='event.stopPropagation(); bookRoom(${JSON.stringify(room).replace(/'/g,"\\'")})'><i class="fa-solid fa-calendar-check"></i> Đặt phòng</button>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function showRoomDetail(room) {
    const popup = document.getElementById('roomDetailPopup');
    const content = document.getElementById('roomDetailContent');
    content.innerHTML = `
      <button class="close-btn" onclick="closeRoomDetail()"><i class="fa-solid fa-xmark"></i></button>
      <img src="${room.img}" alt="${room.name}">
      <h2>${room.name}</h2>
      <div class="price"><i class="fa-solid fa-money-bill-wave"></i> ${room.price.toLocaleString()} đ / đêm</div>
      <div><span class="section-title"><i class="fa-solid fa-user-group"></i> Sức chứa:</span> ${room.guests} người</div>
      <div><span class="section-title"><i class="fa-solid fa-bed"></i> Loại giường:</span> ${room.bedType}</div>
      <div><span class="section-title"><i class="fa-solid fa-maximize"></i> Diện tích:</span> ${room.area}</div>
      <div><span class="section-title"><i class="fa-solid fa-mug-hot"></i> Tiện nghi:</span>
        <ul>${room.amenities.map(a => `<li>${a}</li>`).join('')}</ul>
      </div>
      <div><span class="section-title"><i class="fa-solid fa-bell-concierge"></i> Dịch vụ:</span>
        <ul>${room.services.map(s => `<li>${s}</li>`).join('')}</ul>
      </div>
      <button class="book-btn" onclick='bookRoom(${JSON.stringify(room).replace(/'/g,"\\'")});closeRoomDetail();'><i class="fa-solid fa-calendar-check"></i> Đặt phòng</button>
    `;
    popup.classList.add('active');
  }

  function closeRoomDetail() {
    document.getElementById('roomDetailPopup').classList.remove('active');
  }

  function bookRoom(room) {
    localStorage.setItem('selectedRoomName', room.name);
    localStorage.setItem('selectedRoomCode', room.code);
    window.location.href = 'DatPhong.html';
  }

  function applyFilter() {
    const nameKeyword = document.getElementById('searchName').value.toLowerCase();
    const guests = document.getElementById('guests').value;
    const minPrice = parseInt(document.getElementById('minPrice').value);
    const maxPrice = parseInt(document.getElementById('maxPrice').value);
    const sort = document.querySelector('input[name="sort"]:checked').value;

    let filtered = rooms.filter(room => {
      const matchesName = room.name.toLowerCase().includes(nameKeyword);
      const matchesGuests = guests ? room.guests === parseInt(guests) : true;
      const matchesPrice = room.price >= minPrice && room.price <= maxPrice;
      return matchesName && matchesGuests && matchesPrice;
    });

    if (sort === 'asc') {
      filtered.sort((a, b) => a.price - b.price);
    } else if (sort === 'desc') {
      filtered.sort((a, b) => b.price - a.price);
    } else if (sort === 'popular') {
      filtered.sort((a, b) => b.popularity - a.popularity);
    }

    renderRooms(filtered);
  }

  function getUserEmail() {
    let email = localStorage.getItem('user_email');
    if (!email) {
      email = prompt('Vui lòng nhập email đã dùng để đặt phòng:');
      if (email) localStorage.setItem('user_email', email);
    }
    return email;
  }

  function renderHistory() {
    const historyList = document.getElementById('history-list');
    const email = getUserEmail();
    if (!email) {
      historyList.innerHTML = '<span style="color:#d10000;">Vui lòng đăng nhập để xem lịch sử đặt phòng.</span>';
      return;
    }
    historyList.innerHTML = '<span>Đang tải...</span>';
    fetch('PHP/get_bookings.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'email=' + encodeURIComponent(email)
    })
    .then(res => res.json())
    .then(data => {
      if (!data.success || !data.bookings || data.bookings.length === 0) {
        historyList.innerHTML = '<span style="color:#888;">Chưa có lịch sử thuê phòng.</span>';
        return;
      }
      historyList.innerHTML = '';
      data.bookings.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <strong>${item.room || item.name}</strong>
          <span>Khách: ${item.fullname || ''}</span>
          <span>Điện thoại: ${item.phone || ''}</span>
          <span>Email: ${item.email || ''}</span>
          <span>Nhận phòng: ${item.checkin || ''}</span>
          <span>Trả phòng: ${item.checkout || ''}</span>
          <span>Mã đặt phòng: ${item.bookingCode || item.code || '(Chưa thanh toán)'}</span>
          <span>Thời gian đặt: ${item.time || ''}</span>
        `;
        historyList.appendChild(div);
      });
    })
    .catch(() => {
      historyList.innerHTML = '<span style="color:#d10000;">Lỗi tải lịch sử đặt phòng.</span>';
    });
  }

  fetchRooms();
  renderHistory();

  window.addEventListener('pageshow', function() {
    renderHistory();
  });
</script>
</body>
</html>